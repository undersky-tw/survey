<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è˜‹å¤©ä¸‹ é¡§å®¢å•å·</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #dce3e8;
            margin: 0; 
            padding: 16px; 
            color: #333; 
        }

        .container { max-width: 600px; margin: 0 auto; }
        
        .card { 
            background: #fff; 
            border-radius: 10px; 
            padding: 18px; 
            margin-bottom: 16px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .form-group { margin-bottom: 10px; }
        label.question-title { display: block; font-weight: 600; margin-bottom: 12px; font-size: 16px; color: #37474f; }
        .required { color: #d32f2f; margin-left: 3px; }

        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 6px; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; background-color: #fff; }
        input[readonly] { background-color: #eceff1; color: #546e7a; border: 1px solid #cfd8dc; font-weight: 500; }

        .hidden-radio { display: none; }
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .btn-option { display: flex; justify-content: center; align-items: center; width: 100%; padding: 14px 10px; background-color: #fff; border: 1px solid #cfd8dc; border-radius: 6px; cursor: pointer; font-size: 15px; color: #455a64; transition: background-color 0.1s, border-color 0.1s; box-sizing: border-box; text-align: center; }
        .hidden-radio:checked + .btn-option { background-color: #455a64; color: #ffffff; border-color: #455a64; font-weight: 600; box-shadow: 0 2px 4px rgba(69, 90, 100, 0.2); }

        .scale-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .scale-option { padding: 12px 0; }

        .btn-submit { background-color: #455a64; color: white; border: none; padding: 16px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .btn-submit:disabled { background-color: #b0bec5; }

        /* é è¨­éš±è—å€å¡Š */
        #survey-form { display: none; }
        #success-message { display: none; text-align: center; padding: 40px 20px; }
        #error-message { display: none; text-align: center; padding: 40px 20px; }
        #loading { text-align: center; padding: 50px; color: #546e7a; font-weight: bold; }

        .error-icon { font-size: 50px; color: #d32f2f; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>

    <div id="loading">æª¢æŸ¥èº«ä»½ä¸­...</div>

    <div class="container" id="error-message">
        <div class="card">
            <span class="error-icon">ğŸ”’</span>
            <h2>ç„¡æ³•å­˜å–</h2>
            <p>æ‚¨æ²’æœ‰æ¬Šé™å¡«å¯«æ­¤å•å·ï¼Œ<br>æˆ–æ˜¯é€£çµå·²å¤±æ•ˆã€‚</p>
        </div>
    </div>

    <div class="container" id="survey-form">
        <form id="myForm">
            <input type="hidden" id="repairId" name="repairId">
            <input type="hidden" id="receiver" name="receiver">
            <input type="hidden" id="technician" name="technician">
            <input type="hidden" id="handover" name="handover">

            <div class="card"><label class="question-title">è«‹å•æ‚¨è¦ºå¾—æœå‹™äººå“¡çš„æ…‹åº¦å¦‚ä½•ï¼Ÿ<span class="required">*</span></label><div class="options-container"><input type="radio" name="q1" id="q1-1" value="éå¸¸æ»¿æ„" class="hidden-radio" required><label for="q1-1" class="btn-option">éå¸¸æ»¿æ„</label><input type="radio" name="q1" id="q1-2" value="é‚„ä¸éŒ¯" class="hidden-radio"><label for="q1-2" class="btn-option">é‚„ä¸éŒ¯</label><input type="radio" name="q1" id="q1-3" value="æ™®é€š" class="hidden-radio"><label for="q1-3" class="btn-option">æ™®é€š</label><input type="radio" name="q1" id="q1-4" value="ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·" class="hidden-radio"><label for="q1-4" class="btn-option">ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·</label><input type="radio" name="q1" id="q1-5" value="å¾ˆç³Ÿç³•" class="hidden-radio"><label for="q1-5" class="btn-option">å¾ˆç³Ÿç³•</label></div></div>
            <div class="card"><label class="question-title">è«‹å•æ‚¨è¦ºå¾—æœå‹™äººå“¡çš„å°ˆæ¥­åº¦å¦‚ä½•ï¼Ÿ<span class="required">*</span></label><div class="options-container"><input type="radio" name="q2" id="q2-1" value="éå¸¸å°ˆæ¥­" class="hidden-radio" required><label for="q2-1" class="btn-option">éå¸¸å°ˆæ¥­</label><input type="radio" name="q2" id="q2-2" value="é‚„ä¸éŒ¯" class="hidden-radio"><label for="q2-2" class="btn-option">é‚„ä¸éŒ¯</label><input type="radio" name="q2" id="q2-3" value="æ™®é€š" class="hidden-radio"><label for="q2-3" class="btn-option">æ™®é€š</label><input type="radio" name="q2" id="q2-4" value="ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·" class="hidden-radio"><label for="q2-4" class="btn-option">ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·</label><input type="radio" name="q2" id="q2-5" value="å¯èƒ½è¦ç æ‰é‡ç·´" class="hidden-radio"><label for="q2-5" class="btn-option">å¯èƒ½è¦ç æ‰é‡ç·´</label></div></div>
            <div class="card"><label class="question-title">è«‹å•æ‚¨è¦ºå¾—ç¶­ä¿®å¸«åœ¨æ•´å€‹ç¶­ä¿®éç¨‹çš„èªªæ˜å¦‚ä½•ï¼Ÿ<span class="required">*</span></label><div class="options-container"><input type="radio" name="q3" id="q3-1" value="éå¸¸è©³ç´°" class="hidden-radio" required><label for="q3-1" class="btn-option">éå¸¸è©³ç´°</label><input type="radio" name="q3" id="q3-2" value="æ»¿æ¸…æ¥šçš„" class="hidden-radio"><label for="q3-2" class="btn-option">æ»¿æ¸…æ¥šçš„</label><input type="radio" name="q3" id="q3-3" value="æ™®é€š" class="hidden-radio"><label for="q3-3" class="btn-option">æ™®é€š</label><input type="radio" name="q3" id="q3-4" value="å¾ˆç°¡ç•¥" class="hidden-radio"><label for="q3-4" class="btn-option">å¾ˆç°¡ç•¥</label><input type="radio" name="q3" id="q3-5" value="å®Œå…¨æ²’èªªæ˜" class="hidden-radio"><label for="q3-5" class="btn-option">å®Œå…¨æ²’èªªæ˜</label></div></div>
            <div class="card"><label class="question-title">è«‹å•æ‚¨å°æ•´å€‹æ¶ˆè²»é«”é©—çš„æ„Ÿè¦ºå¦‚ä½•ï¼Ÿ<span class="required">*</span></label><div class="options-container"><input type="radio" name="q4" id="q4-1" value="éå¸¸å¥½çš„é«”é©—" class="hidden-radio" required><label for="q4-1" class="btn-option">éå¸¸å¥½çš„é«”é©—</label><input type="radio" name="q4" id="q4-2" value="æ•´é«”ä¸Šé‚„ä¸éŒ¯" class="hidden-radio"><label for="q4-2" class="btn-option">æ•´é«”ä¸Šé‚„ä¸éŒ¯</label><input type="radio" name="q4" id="q4-3" value="æ™®é€š" class="hidden-radio"><label for="q4-3" class="btn-option">æ™®é€š</label><input type="radio" name="q4" id="q4-4" value="ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·" class="hidden-radio"><label for="q4-4" class="btn-option">ä¸å¤ªè¡Œï¼Œæœ‰å¾…åŠ å¼·</label><input type="radio" name="q4" id="q4-5" value="å¾ˆç³Ÿç³•" class="hidden-radio"><label for="q4-5" class="btn-option">å¾ˆç³Ÿç³•</label></div></div>
            <div class="card"><label class="question-title">æ˜¯å¦æœƒæ¨è–¦è¦ªå‹ä¾†è˜‹å¤©ä¸‹ï¼Ÿ<span class="required">*</span></label><p style="font-size:13px; color:#78909c; margin-top:-8px; margin-bottom: 12px;">(10åˆ†:çµ•å°æœƒ / 1åˆ†:çµ•å°ä¸å¯èƒ½)</p><div class="scale-grid"><input type="radio" name="q5" id="s10" value="10" class="hidden-radio" required><label for="s10" class="btn-option scale-option">10</label><input type="radio" name="q5" id="s9" value="9" class="hidden-radio"><label for="s9" class="btn-option scale-option">9</label><input type="radio" name="q5" id="s8" value="8" class="hidden-radio"><label for="s8" class="btn-option scale-option">8</label><input type="radio" name="q5" id="s7" value="7" class="hidden-radio"><label for="s7" class="btn-option scale-option">7</label><input type="radio" name="q5" id="s6" value="6" class="hidden-radio"><label for="s6" class="btn-option scale-option">6</label><input type="radio" name="q5" id="s5" value="5" class="hidden-radio"><label for="s5" class="btn-option scale-option">5</label><input type="radio" name="q5" id="s4" value="4" class="hidden-radio"><label for="s4" class="btn-option scale-option">4</label><input type="radio" name="q5" id="s3" value="3" class="hidden-radio"><label for="s3" class="btn-option scale-option">3</label><input type="radio" name="q5" id="s2" value="2" class="hidden-radio"><label for="s2" class="btn-option scale-option">2</label><input type="radio" name="q5" id="s1" value="1" class="hidden-radio"><label for="s1" class="btn-option scale-option">1</label></div></div>
            <div class="card"><label class="question-title">æ„è¦‹å›é¥‹ (å¯ç•™ç©º)</label><textarea name="q6" rows="3" placeholder="æ­¡è¿æ‚¨çš„ç•™è¨€"></textarea></div>

            <button type="submit" id="btnSubmit" class="btn-submit">é€å‡ºå•å·</button>
        </form>
    </div>

    <div class="container" id="success-message">
        <div class="card" style="text-align: center; padding: 40px 20px;">
            <h2>å•å·å·²é€å‡ºï¼Œæ„Ÿè¬æ‚¨ ğŸ‘ğŸ»</h2>
            <div id="review-request" style="display: none; margin-top: 20px;">
                <p style="color: #37474f; line-height: 1.8; font-size: 15px; text-align: left;">
                    è‹¥æ‚¨æ»¿æ„é€™æ¬¡çš„æœå‹™ï¼Œå¯å¦å¹«æˆ‘å€‘é»äº®äº”é¡†æ˜Ÿæ˜Ÿï¼Œä¸¦å¯«ä¸‹æ‚¨ç¶­ä¿®çš„æ©Ÿå‹ã€é …ç›®ï¼Œä»¥åŠé«”é©—æ„Ÿå—å—ï¼Ÿé€™æœƒå°æˆ‘å€‘æœ‰è«å¤§çš„å¹«åŠ©ï¼ğŸŒŸ
                </p>
                <a id="google-map-link" href="#" target="_blank" 
                   style="display: block; margin: 20px auto 0; padding: 14px 24px; background-color: #4285f4; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.15); width: fit-content;">
                    å‰å¾€ Google è©•è«–
                </a>
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Google Apps Script ç¶²å€ (çµå°¾ /exec) â˜…â˜…â˜…
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwUFddDJpIkhR0kEotJBzdvvfPimcwlJCsMkCbCkwp7Ki868NyCmKnEB-BbzTNQEansfg/exec";
        
        // 1. åˆå§‹åŒ– LIFF ä¸¦æª¢æŸ¥èº«ä»½
        window.onload = function() {
            // åˆå§‹åŒ– LIFF
            liff.init({ liffId: "2008598904-yJnqeEj3" })
            .then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login(); // å¦‚æœæ²’ç™»å…¥ï¼Œå¼·åˆ¶ç™»å…¥
                    return;
                }
                
                // å–å¾—ç¶²å€åƒæ•¸
                const urlParams = new URLSearchParams(window.location.search);
                const allowedUid = urlParams.get('uid');
                
                // å–å¾—ç›®å‰ä½¿ç”¨è€…è³‡æ–™
                liff.getProfile()
                .then(profile => {
                    const currentUserId = profile.userId;
                    
                    // â˜… èº«ä»½é©—è­‰é‚è¼¯ â˜…
                    // å¦‚æœç¶²å€æœ‰æŒ‡å®š uidï¼Œä¸”èˆ‡ç•¶å‰ä½¿ç”¨è€…ä¸ç¬¦ï¼Œå°±æ“‹ä½
                    if (allowedUid && allowedUid !== currentUserId) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('error-message').style.display = 'block';
                    } else {
                        // é©—è­‰é€šéï¼Œæˆ–ç¶²å€æ²’æœ‰é–å®š uid (ç›¸å®¹èˆŠé€£çµ)
                        showForm(urlParams);
                    }
                })
                .catch(err => {
                    console.error("LIFF Profile Error:", err);
                    // å¦‚æœå–ä¸åˆ°å€‹è³‡ï¼Œä¿å®ˆèµ·è¦‹å…ˆé¡¯ç¤ºè¡¨å–®ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é¸æ“‡å ±éŒ¯
                    showForm(urlParams);
                });
            })
            .catch(err => {
                console.error("LIFF Init Error:", err);
            });
        };

        // åº—åˆ¥å°æ‡‰çš„ Google Map é€£çµ
        const SHOP_MAP_URLS = {
            "ğŸ—¿ é³³å±±": "https://maps.app.goo.gl/wnfzHWXnzYiLtkZR6",
            "ğŸŒ² æ˜èª ": "https://maps.app.goo.gl/7bEH7M5W4vjRCdiS6",
            "ğŸ‹ è‹“é›…": "https://maps.app.goo.gl/yECYBxPL7R5SWR9RA"
        };

        let currentShopName = ""; // ç”¨ä¾†å„²å­˜ç•¶å‰åº—åˆ¥

        function showForm(urlParams) {
            // å¡«å…¥éš±è—æ¬„ä½
            document.getElementById('repairId').value = urlParams.get('id') || "ç„¡ç·¨è™Ÿ";
            document.getElementById('receiver').value = urlParams.get('r') || "";
            document.getElementById('technician').value = urlParams.get('t') || "";
            document.getElementById('handover').value = urlParams.get('h') || ""; // â˜… æ–°å¢äº¤æ©Ÿè€…
            
            // â˜… æ–°å¢ï¼šå„²å­˜åº—åˆ¥è³‡è¨Šï¼ˆç”¨æ–¼å¾ŒçºŒé¡¯ç¤º Google Map é€£çµï¼‰
            currentShopName = urlParams.get('shop') || "";
            
            // åˆ‡æ›ç•«é¢
            document.getElementById('loading').style.display = 'none';
            document.getElementById('survey-form').style.display = 'block';
        }

        // 2. é€å‡ºè¡¨å–®
        document.getElementById('myForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');

            const form = e.target;
            const data = {
                action: "save_survey",
                data: {
                    id: form.repairId.value,
                    receiver: form.receiver.value,
                    technician: form.technician.value,
                    handover: form.handover.value, // â˜… æ–°å¢äº¤æ©Ÿè€…
                    q1: form.querySelector('input[name="q1"]:checked')?.value,
                    q2: form.querySelector('input[name="q2"]:checked')?.value,
                    q3: form.querySelector('input[name="q3"]:checked')?.value,
                    q4: form.querySelector('input[name="q4"]:checked')?.value,
                    q5: form.querySelector('input[name="q5"]:checked')?.value,
                    q6: form.querySelector('textarea[name="q6"]').value
                }
            };
            
            const jsonString = JSON.stringify(data);

            // â˜… æ¨‚è§€æ›´æ–°ï¼šç«‹å³é¡¯ç¤ºæ„Ÿè¬é é¢ï¼Œä¸ç­‰å¾…ä¼ºæœå™¨å›æ‡‰
            btn.disabled = true;
            btn.innerText = "é€å‡ºä¸­...";
            
            // ç«‹å³é¡¯ç¤ºæ„Ÿè¬é é¢ï¼ˆè¦–è¦ºä¸Šæ›´å¿«ï¼‰
            showSuccess();

            // åœ¨èƒŒæ™¯å‚³é€è³‡æ–™ï¼ˆä¸é˜»æ“‹ UIï¼‰
            // å„ªå…ˆä½¿ç”¨ sendBeaconï¼ˆæ›´å¯é ï¼‰ï¼Œå¤±æ•—æ‰ç”¨ fetch
            if (navigator.sendBeacon) {
                const blob = new Blob([jsonString], { type: 'text/plain; charset=utf-8' });
                navigator.sendBeacon(SCRIPT_URL, blob);
            } else {
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: jsonString
                }).catch(err => console.error('èƒŒæ™¯å‚³é€å¤±æ•—:', err));
            }
        });

        function showSuccess() {
            // â˜… æ–°æµç¨‹ï¼šå–å¾—æ¨è–¦åˆ†æ•¸
            const recommendScore = parseInt(document.querySelector('input[name="q5"]:checked')?.value || 0);
            
            // åˆ‡æ›åˆ°æ„Ÿè¬é é¢
            document.getElementById('survey-form').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            
            // å¦‚æœæ¨è–¦åˆ†æ•¸ >= 8ï¼Œé¡¯ç¤º Google è©•è«–é‚€è«‹
            if (recommendScore >= 8) {
                const mapUrl = getShopMapUrl(currentShopName);
                if (mapUrl) {
                    document.getElementById('review-request').style.display = 'block';
                    document.getElementById('google-map-link').href = mapUrl;
                }
                // ä¸è‡ªå‹•é—œé–‰è¦–çª—ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é»æ“Šé€£çµ
            } else {
                // æ¨è–¦åˆ†æ•¸ < 8ï¼Œåªé¡¯ç¤ºæ„Ÿè¬è¨Šæ¯ï¼Œ3 ç§’å¾Œè‡ªå‹•é—œé–‰
                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 3000);
            }
        }

        // æ ¹æ“šåº—åˆ¥å–å¾—å°æ‡‰çš„ Google Map é€£çµ
        function getShopMapUrl(shopName) {
            // å…ˆå˜—è©¦å®Œå…¨åŒ¹é…
            if (SHOP_MAP_URLS[shopName]) {
                return SHOP_MAP_URLS[shopName];
            }
            // å¦‚æœæ²’æœ‰å®Œå…¨åŒ¹é…ï¼Œå˜—è©¦éƒ¨åˆ†åŒ¹é…ï¼ˆå®¹éŒ¯ï¼‰
            for (const key in SHOP_MAP_URLS) {
                if (shopName.includes("é³³å±±") || key.includes(shopName)) {
                    return SHOP_MAP_URLS["ğŸ—¿ é³³å±±"];
                }
                if (shopName.includes("æ˜èª ") || key.includes(shopName)) {
                    return SHOP_MAP_URLS["ğŸŒ² æ˜èª "];
                }
                if (shopName.includes("è‹“é›…") || key.includes(shopName)) {
                    return SHOP_MAP_URLS["ğŸ‹ è‹“é›…"];
                }
            }
            return null;
        }
    </script>
</body>
</html>
